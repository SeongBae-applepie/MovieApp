<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CineVerse</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <link href="../css/login.css" rel="stylesheet" />
  </head>
  <body>
    <nav
      class="navbar navbar-light"
      style="background-color: red; height: 10vh"
    >
      <div class="container"></div>
    </nav>
    <img
      id="logo"
      src="../img/CineUniverse.png"
      alt="CineUniverse"
      class="img-fluid"
    />

    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-4 col-md-6">
          <div class="login-wrapper" style="margin-top: -20%">
            <h2>Login</h2>
            <form disabled id="login-form">
              <div class="form-group">
                <input
                  id="user_id"
                  type="text"
                  class="form-control"
                  name="email"
                  placeholder="Email"
                />
              </div>
              <div class="form-group">
                <input
                  id="user_passwd"
                  type="password"
                  class="form-control"
                  name="userPassword"
                  placeholder="Password"
                />
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-4 col-md-6">
          <div class="d-grid gap-2" style="margin-top: 2%">
            <button
              id="login"
              onclick="btn_login()"
              class="btn btn-danger"
              type="submit"
              value="Login"
            >
              Login
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col">
          <a id="custom-login-btn" href="javascript:loginWithKakao()">
            <img
              id="kakaologin"
              src="//k.kakaocdn.net/14/dn/btqCn0WEmI3/nijroPfbpCa4at5EIsjyf0/o.jpg"
              style="width: 50%; height: 60%; margin-top: 2%"
              class="img-fluid"
              alt="Kakao Login"
            />
          </a>
          <a
            href="http://127.0.0.1:51713/join"
            style="
              width: 50%;
              height: 60%;
              margin-left: 15%;
              margin-top: 10%;
              text-decoration: none;
              color: black;
            "
            >회원가입</a
          >
        </div>
      </div>
    </div>
    <!-- 하단 네비게이션바 -->
    <nav
      class="navbar fixed-bottom"
      style="background-color: red; height: 10vh"
    >
      <div class="container"></div>
    </nav>

    <!--<button class="api-btn" onclick="kakaoLogout()">로그아웃</button>-->

    <script type="text/javascript">
      // 2. 카카오 초기화
      Kakao.init("3d95c617c738c50b0bed0103658da3a5");
      console.log(Kakao.isInitialized()); // 초기화 판단여부

      function loginWithKakao() {
        Kakao.Auth.login({
          success: function (authObj) {
            console.log(authObj); // access토큰 값
            Kakao.Auth.setAccessToken(authObj.access_token); // access토큰값 저장

            getInfo();
          },
          fail: function (err) {
            console.log(err);
          },
        });
      }

      // 4. 엑세스 토큰을 발급받고, 아래 함수를 호출시켜서 사용자 정보를 받아옴.
      function getInfo() {
        Kakao.API.request({
          url: "/v2/user/me",
          success: function (res) {
            var email = res.kakao_account.email;
            var nickname = res.kakao_account.profile.nickname;
            var profile_image = res.kakao_account.profile.thumbnail_image_url;

            // 서버로 사용자 데이터 전송
            fetch("/save_user", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email, nickname, profile_image }),
            })
              .then((response) => response.text())
              .then((text) => {
                console.log(text);
                window.location.href = "/test"; // 홈페이지로 리다이렉트
              })
              .catch((error) => {
                console.error("Error:", error);
                alert("사용자 데이터 전송 중 에러가 발생했습니다."); // 사용자에게 에러 메시지 보여주기
              });
          },
          fail: function (error) {
            alert(
              "카카오 로그인에 실패했습니다. 관리자에게 문의하세요." +
                JSON.stringify(error)
            );
          },
        });
      }

      // 5. 로그아웃 기능 - 카카오 서버에 접속하는 엑세스 토큰을 만료, 사용자 어플리케이션의 로그아웃은 따로 진행.
      function kakaoLogout() {
        if (!Kakao.Auth.getAccessToken()) {
          alert("Not logged in.");
          return;
        }
        Kakao.Auth.logout(function () {
          alert("logout ok\naccess token -> " + Kakao.Auth.getAccessToken());
        });
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
      crossorigin="anonymous"
    ></script>
  </body>
  <script src="../js/login2.js"></script>
</html>
